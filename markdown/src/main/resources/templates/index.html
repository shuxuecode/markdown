<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>文档</title>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="/zTree/bootstrapStyle/bootstrapStyle.css"/>

    <link rel="stylesheet" href="/editormd/css/editormd.min.css"/>
    <link rel="stylesheet" href="/editormd/css/editormd.preview.css"/>

    <link rel="stylesheet" href="/css/index.css"/>
    <style type="text/css">
        div#rMenu {
            position: absolute;
            visibility: hidden;
            top: 0;
            background-color: #555;
            text-align: left;
            padding: 2px;
        }

        div#rMenu ul {
            margin: 0;
            padding: 0;
        }

        div#rMenu ul li {
            margin: 1px 0;
            padding: 0 5px;
            cursor: pointer;
            list-style: none outside none;
            background-color: #DFDFDF;
        }
    </style>
</head>
<body>

<header>
    <div>
        <button onclick="javascript:initEditor()">新增</button>
        <button onclick="javascript:save()">保存</button>
    </div>
</header>

<div class="container">

    <div class="left-menu">
        <ul id="treeDemo" class="ztree"></ul>
    </div>

    <div class="main">
        <div>
            <input class="title-cls" id="title" placeholder="标题" />
        </div>
        <div id="editor">
            <!-- Tips: Editor.md can auto append a `<textarea>` tag -->
            <textarea style="display:none;">### Hello Editor.md !</textarea>
        </div>
    </div>
</div>


<div id="rMenu">
    <ul>
        <li id="m_add" onclick="addTreeNode();">新建笔记</li>
        <li id="m_del" onclick="addTreeNode2();">新建笔记（同级）</li>
        <li id="m_check" onclick="checkTreeNode(true);">Check节点</li>
        <li id="m_unCheck" onclick="checkTreeNode(false);">重命名</li>
        <li id="m_reset" onclick="resetTree();">删除</li>
    </ul>
</div>


<script src="/editormd/js/jquery.min.js"></script>
<script src="/zTree/js/jquery.ztree.core.min.js"></script>
<script src="/editormd/js/editormd.min.js"></script>
<script>
    var zTreeObj;
    // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
    var setting = {
        data: {
            key: {
                name: "title"
            }
        },
        callback: {
            onClick: zTreeOnClick,
            onRightClick: OnRightClick
        }
    };

    var editor;

    var mdId;
    var pid;
    var parentId;

    var rMenu;

    $(function () {
        getTree();
        rMenu = $("#rMenu");
    });

    function initTree(zNodes) {
        zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
    }

    function getTree() {
        $.ajax({
            type: "get",
            url: "/note/tree",
            data: {},
            dataType: "json",
            contentType: "application/json;charset=UTF-8",
            success: function (res) {
                console.info(res)
                if (res && res.success) {
                    initTree(res.data)
                }
            }
        })
    }

    var initEditor = function (text) {
        if (text == undefined || text == null || text == "") {
            text = "# 标题"
        }
        editor = editormd("editor", {
            width: "100%",
            height: 600,
            markdown: text,
            path: "/editormd/lib/",
            imageUpload: true,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
        })
    }

    function getData(id) {
        // $.get("/get", function (res) {
        //     console.log(res)
        // });

        mdId = id;

        $.ajax({
            type: "get",
            url: "/note/get/" + id,
            data: {},
            dataType: "json",
            contentType: "application/json;charset=UTF-8",
            success: function (res) {
                console.info(res)
                if (res && res.success) {
                    $("#title").val(res.data.title);
                    initEditor(res.data.text)
                }
                // initEditor(res)
            }
        })
    }

    function save() {

        let text = editor.getMarkdown();

        if(mdId){

        }else{
            mdId = null;
        }
        var formData = {
            id: mdId,
            pid: pid,
            title: $("#title").val(),
            text: text
        };

        $.ajax({
            type: "post",
            url: "/note/save",
            data: JSON.stringify(formData),
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: function (res) {
                console.info(res)
            }
        })
    }

    function zTreeOnClick(event, treeId, treeNode) {
        console.info(treeNode)
        // alert(treeNode.tId + ", " + treeNode.title);
        getData(treeNode.id);
    }

    function OnRightClick(event, treeId, treeNode) {
        console.info(treeNode)
        pid = treeNode.id;
        parentId = treeNode.pid;
        console.info("event.clientX : ", event.clientX)
        console.info("event.clientY : ", event.clientY)

        // if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
        //     zTree.cancelSelectedNode();
            showRMenu("root", event.clientX, event.clientY);
        // } else if (treeNode && !treeNode.noR) {
        //     zTree.selectNode(treeNode);
        //     showRMenu("node", event.clientX, event.clientY);
        // }
    }

    function showRMenu(type, x, y) {
        $("#rMenu ul").show();
        y += document.body.scrollTop;
        x += document.body.scrollLeft;
        rMenu.css({"top":y+"px", "left":x+"px", "visibility":"visible"});

        $("body").bind("mousedown", onBodyMouseDown);
    }

    function onBodyMouseDown(event){
        if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length>0)) {
            rMenu.css({"visibility" : "hidden"});
        }
    }

    function hideRMenu() {
        if (rMenu) rMenu.css({"visibility": "hidden"});
        $("body").unbind("mousedown", onBodyMouseDown);
    }

    function addTreeNode() {
        hideRMenu();
        initEditor();
        mdId = undefined
        console.log("pid = ", pid)
    }
    
    function addTreeNode2() {
        hideRMenu();
        initEditor();
        mdId = undefined
        console.log("pid = ", pid)
        console.log("parentId = ", parentId)
        pid = parentId;
        console.log("修改后pid = ", pid)
    }


</script>
</body>
</html>